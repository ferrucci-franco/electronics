<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chirp â†’ Two Adjustable Filters</title>
<meta name="description" content="Linear chirp (10 s @ 44.1 kHz, 100â†’2000 Hz), two adjustable filters, audio playback of input & outputs, time plot and Bode plot.">
<style>
  :root{
    --bg:#ffffff; --fg:#0f1222; --muted:#5a6275; --card:#f7f8fb; --border:#e6eaf3; --link:#0b6cff;
    --paper:#ffffff; --plot:#ffffff;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0e15; --fg:#eaf0ff; --muted:#a9b1c6; --card:#111624; --border:#1d2540; --link:#8ab4ff;
           --paper:#111624; --plot:#111624; }
  }
  html.dark{ --bg:#0b0e15; --fg:#eaf0ff; --muted:#a9b1c6; --card:#111624; --border:#1d2540; --link:#8ab4ff;
             --paper:#111624; --plot:#111624; }
  html.light{ --bg:#ffffff; --fg:#0f1222; --muted:#5a6275; --card:#f7f8fb; --border:#e6eaf3; --link:#0b6cff;
              --paper:#ffffff; --plot:#ffffff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  a{color:var(--link)}
  .grid{display:grid;grid-template-columns:320px 1fr 1fr;gap:10px;padding:10px;height:100vh}
  .panel{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;min-width:0}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font-size:15px}
  input[type=range]{width:100%}
  .badge{font-variant-numeric:tabular-nums;border:1px solid var(--border);border-radius:999px;padding:2px 8px}
  .controls button, .controls input[type=range]{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:8px 10px}
  .controls button{cursor:pointer}
  .controls button:hover{ filter: brightness(0.6); }
  .controls button:focus-visible{ outline: 2px solid currentColor; outline-offset: 2px; }
  .seg{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .seg button{border:0;background:transparent;color:var(--muted);padding:6px 10px;cursor:pointer}
  .seg button.active{background:var(--bg);color:var(--fg)}
  .plotwrap{height:100%;min-height:0}
  #timePlot,#bodePlot{width:100%;height:100%}
  #stopAll{border-color:#d12a2a}
  #stopAll .sq, #stopAll .lbl{color:#d12a2a;font-weight:700}
  #status{font-size:12px}

</style>
</head>
<body>
  <div class="grid">
    <!-- Left: Controls -->
    <section class="panel controls">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="title" style="margin:0 0 4px;font-size:18px">Chirp â†’ Two Adjustable Filters</h2>
          <p id="desc" class="muted" style="margin:0">Linear chirp (10 s, 44.1 kHz, 100â†’2000 Hz). Adjust both filters and listen to input and outputs.</p>
        </div>
        <button id="themeBtn" title="Toggle theme">ðŸŒ—</button>
      </div>

      <div class="row" aria-label="language switcher">
        <div class="seg" role="tablist">
          <button id="lang-en" class="active" data-lang="en" role="tab" aria-selected="true">EN</button>
          <button id="lang-fr" data-lang="fr" role="tab" aria-selected="false">FR</button>
          <button id="lang-es" data-lang="es" role="tab" aria-selected="false">ES</button>
        </div>
      </div>

      <div>
        <label id="fc1Label"><strong>Filter 1</strong></label>
        <div class="row"><span id="fc1Val" class="badge">200 Hz</span></div>
        <input id="fc1" type="range" min="1.3010" max="4.3010" step="0.001" />
      </div>

      <div>
        <label id="fc2Label"><strong>Filter 2</strong></label>
        <div class="row"><span id="fc2Val" class="badge">10,000 Hz</span></div>
        <input id="fc2" type="range" min="1.3010" max="4.3010" step="0.001" />
      </div>

      <div class="row" style="margin-top:6px">
        <label for="bodeDb" id="bodeScaleLabel">Y scale: logarithmic / linear</label>
        <input id="bodeDb" type="checkbox" checked />
      </div>

      <div class="row" style="margin-top:6px">
        <span id="audioLabel" class="muted">Audio</span>
        <button id="playIn">â–¶ <span id="inLbl">Input</span></button>
        <button id="playY1">â–¶ <span id="y1Lbl">Output 1</span></button>
        <button id="playY2">â–¶ <span id="y2Lbl">Output 2</span></button>
        <button id="stopAll"><span class="sq">â– </span> <span class="lbl" id="stopLbl">Stop</span></button>
      </div>

      <div class="muted" id="status">Loading chartsâ€¦</div>
      <div class="muted" style="font-size:12px;margin-top:auto">Â© <span id="year"></span> Franco â€” HTML + JavaScript + Plotly + Web Audio</div>
    </section>

    <!-- Middle: Time plot -->
    <section class="panel plotwrap"><div id="timePlot"></div></section>
    <!-- Right: Bode plot -->
    <section class="panel plotwrap"><div id="bodePlot"></div></section>
  </div>

<script>
(function(){
  // ======== Build-state flags MUST come first (used by theme IIFE) ========
  let timeBuilt = false, bodeBuilt = false;
  let bodeCache1 = null, bodeCache2 = null;

  // ======== Config constants ========
  const fs = 44100, duration = 10.0, fStart = 100, fEnd = 2000, amp = 0.8;
  const N = Math.floor(fs * duration);
  const TIME_WINDOW_SEC = 0.5;
  const DECIMATE_EVERY = 1; // plot every i-th point
  const INIT_FC1 = 250;
  const INIT_FC2 = 150;
  const COLORS = {
    input: '#888888',
    f1: '#1f77b4',
    f2: '#ff7f0e'
  };
  function paintButton(sel, color){
  const el = document.querySelector(sel);
  if(!el) return;
  el.style.borderColor = color;
  el.style.color = color;
  el.style.fontWeight = '600';
  el.style.background = 'transparent';
  }

  const Q1 = 0.541196100146197, Q2 = 1.3065629648763766; // stable two-biquad cascade

  // ======== Small helpers ========
  const $ = s => document.querySelector(s);
  const cssVar = n => getComputedStyle(document.documentElement).getPropertyValue(n).trim();
  const log10 = x => Math.log(x) / Math.LN10;
  const pow10 = x => Math.pow(10, x);
  const clampFc = f => Math.max(20, Math.min(0.45*fs, f));
  const hzToSliderVal = hz => log10(Math.max(20, Math.min(20000, hz)));
  const sliderValToHz = v => Math.round(pow10(parseFloat(v)));

  // ======== Theme toggle (safe even before plots) ========
  (function(){
    const btn = $('#themeBtn');
    const apply = m => {
      document.documentElement.classList.remove('light','dark');
      if(m !== 'auto') document.documentElement.classList.add(m);
      localStorage.setItem('theme', m);
      if(window.Plotly && timeBuilt) Plotly.relayout('timePlot', {paper_bgcolor: cssVar('--paper'), plot_bgcolor: cssVar('--plot')});
      if(window.Plotly && bodeBuilt) Plotly.relayout('bodePlot', {paper_bgcolor: cssVar('--paper'), plot_bgcolor: cssVar('--plot')});
    };
    const saved = localStorage.getItem('theme');
    if(saved) apply(saved);
    btn.addEventListener('click', () => {
      const html = document.documentElement;
      if (html.classList.contains('dark')) {
        apply('light');
      } else {
        apply('dark');
      }
    });
  })();

  // ======== Language strings ========
  const TXT = {
    en:{title:'Chirp â†’ Two Adjustable Filters',desc:'Linear chirp (10 s, 44.1 kHz, 100â†’2000 Hz). Adjust both filters and listen to input and outputs.',
        fc1:'Filter 1', fc2:'Filter 2', bodeScale:'Y scale: logarithmic / linear', audio:'Audio',
        inBtn:'Input', y1Btn:'Output 1', y2Btn:'Output 2', stopBtn:'Stop',
        timeTitle:'Time response (first 0.5 s)', bodeTitle:'Bode magnitude â€” Filter 1 vs Filter 2',
        traceIn:'Input', traceY1:'Output 1', traceY2:'Output 2', bodeYdB:'|H| (dB)', bodeYlin:'|H| (linear)', bodeX:'Frequency (Hz)'},
    fr:{title:'Chirp â†’ Deux filtres rÃ©glables',desc:'Chirp linÃ©aire (10 s, 44,1 kHz, 100â†’2000 Hz). Ajustez les filtres et Ã©coutez lâ€™entrÃ©e et les sorties.',
        fc1:'Filtre 1', fc2:'Filtre 2', bodeScale:'Ã‰chelle Y : logarithmique / linÃ©aire', audio:'Audio',
        inBtn:'EntrÃ©e', y1Btn:'Sortie 1', y2Btn:'Sortie 2', stopBtn:'Stop',
        timeTitle:'RÃ©ponse temporelle (0,5 s)', bodeTitle:'Bode â€” Filtre 1 vs Filtre 2',
        traceIn:'EntrÃ©e', traceY1:'Sortie 1', traceY2:'Sortie 2', bodeYdB:'|H| (dB)', bodeYlin:'|H| (linÃ©aire)', bodeX:'FrÃ©quence (Hz)'},
    es:{title:'Chirp â†’ Dos filtros ajustables',desc:'Chirp lineal (10 s, 44.1 kHz, 100â†’2000 Hz). Ajusta los filtros y escucha la entrada y las salidas.',
        fc1:'Filtro 1', fc2:'Filtro 2', bodeScale:'Escala Y: logarÃ­tmica / lineal', audio:'Audio',
        inBtn:'Entrada', y1Btn:'Salida 1', y2Btn:'Salida 2', stopBtn:'Stop',
        timeTitle:'Respuesta temporal (0,5 s)', bodeTitle:'Bode â€” Filtro 1 vs Filtro 2',
        traceIn:'Entrada', traceY1:'Salida 1', traceY2:'Salida 2', bodeYdB:'|H| (dB)', bodeYlin:'|H| (lineal)', bodeX:'Frecuencia (Hz)'}
  };
  const langBtns = [$('#lang-en'), $('#lang-fr'), $('#lang-es')];
  let LANG = 'en';
  function setLang(l){
    LANG = l; const t = TXT[l];
    $('#title').textContent = t.title; $('#desc').textContent = t.desc;
    $('#fc1Label').textContent = t.fc1; $('#fc2Label').textContent = t.fc2;
    $('#bodeScaleLabel').textContent = t.bodeScale; $('#audioLabel').textContent = t.audio;
    $('#inLbl').textContent = t.inBtn; $('#y1Lbl').textContent = t.y1Btn; $('#y2Lbl').textContent = t.y2Btn; $('#stopLbl').textContent = t.stopBtn;
    langBtns.forEach(b=>{ const on=(b.dataset.lang===l); b.classList.toggle('active', on); b.setAttribute('aria-selected', on); });
    document.documentElement.lang = l;
    if(window.Plotly && timeBuilt){
      Plotly.relayout('timePlot', {
        'legend.orientation': 'h', 'legend.x': 0.5, 'legend.xanchor': 'center', 'legend.y': 1.02, 'legend.yanchor': 'bottom',
        'title.text': '<b>' + t.timeTitle + '</b>', 'title.font.size': 20, 'title.x': 0.5, 'title.xanchor': 'center',
        'margin.t': 100
      });
      Plotly.restyle('timePlot', {name:[t.traceIn,t.traceY1,t.traceY2]}, [0,1,2]);
    }
    if(window.Plotly && bodeBuilt){
      Plotly.relayout('bodePlot', {
        'legend.orientation': 'h', 'legend.x': 0.5, 'legend.xanchor': 'center', 'legend.y': 1.02, 'legend.yanchor': 'bottom',
        'title.text': '<b>' + t.bodeTitle + '</b>', 'title.font.size': 20, 'title.x': 0.5, 'title.xanchor': 'center',
        'margin.t': 100, 'xaxis.title': t.bodeX
      });
      applyBodeMode();
    }
  }
  langBtns.forEach(b => b.addEventListener('click', ()=> setLang(b.dataset.lang)));

  // ======== Signal ========
  const x = (function(){
    const arr = new Float32Array(N);
    const k = (fEnd - fStart)/duration;
    for(let n=0;n<N;n++){ const t=n/fs; const ph=2*Math.PI*(fStart*t + 0.5*k*t*t); arr[n]=amp*Math.sin(ph); }
    return arr;
  })();

  // ======== Filter ========
  function biquadLPButter(fc, Q){
    const w_pw = 2*fs * Math.tan(Math.PI*fc/fs); // prewarp
    const K=2*fs, A=K*K, B=K*w_pw/Q, C=w_pw*w_pw;
    let b0=C,b1=2*C,b2=C, a0=A+B+C, a1=2*(C-A), a2=A-B+C;
    b0/=a0; b1/=a0; b2/=a0; a1/=a0; a2/=a0;
    return {b0,b1,b2,a1,a2};
  }
  function biquadProcess(sig,c){
    const y=new Float32Array(sig.length); let s1=0,s2=0; const {b0,b1,b2,a1,a2}=c;
    for(let n=0;n<sig.length;n++){ const w=sig[n]-a1*s1-a2*s2; const out=b0*w+b1*s1+b2*s2; s2=s1; s1=w; y[n]=out; }
    return y;
  }
  function lp2x(sig, fc){ fc=clampFc(fc); return biquadProcess(biquadProcess(sig,biquadLPButter(fc,Q1)), biquadLPButter(fc,Q2)); }

  const state = { fc1: INIT_FC1, fc2: INIT_FC2, y1:null, y2:null, bodeDb:true, buffers:{in:null,y1:null,y2:null} };
  function updateFilters(){ state.y1 = lp2x(x, state.fc1); state.y2 = lp2x(x, state.fc2); }

  // ======== Plot helpers ========
  function decimateXY(sig){
    const count = Math.min(Math.floor(TIME_WINDOW_SEC*fs), sig.length);
    const step = DECIMATE_EVERY, M = Math.floor(count/step);
    const tx = new Array(M), ty = new Array(M);
    for(let i=0;i<M;i++){ const n=i*step; tx[i]=n/fs; ty[i]=sig[n]; }
    return {x:tx, y:ty};
  }
  function bodeFor(fc, nPts=512){
    const c1=biquadLPButter(fc,Q1), c2=biquadLPButter(fc,Q2);
    const fmin=10,fmax=fs/2, f=new Array(nPts), mag=new Array(nPts);
    for(let i=0;i<nPts;i++){
      const a=i/(nPts-1), ff=Math.pow(10, Math.log10(fmin)+a*(Math.log10(fmax)-Math.log10(fmin)));
      const w=2*Math.PI*ff/fs, z1r=Math.cos(-w),z1i=Math.sin(-w), z2r=Math.cos(-2*w),z2i=Math.sin(-2*w);
      function Hsec(s){ const nr=s.b0+s.b1*z1r+s.b2*z2r, ni=s.b1*z1i+s.b2*z2i, dr=1+s.a1*z1r+s.a2*z2r, di=s.a1*z1i+s.a2*z2i; const den=dr*dr+di*di; const hr=(nr*dr+ni*di)/den, hi=(ni*dr-nr*di)/den; return Math.hypot(hr,hi); }
      f[i]=ff; mag[i]= Hsec(c1)*Hsec(c2);
    }
    return {f,mag};
  }

  // ======== Plotly dynamic loader (multi-CDN) ========
  const PLOTLY_URLS = [
    "https://cdn.plot.ly/plotly-2.32.0.min.js",
    "https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.32.0/plotly.min.js",
    "https://unpkg.com/plotly.js-dist-min@2.32.0/plotly.min.js"
  ];
  function loadPlotly(urls, onOk, onFail){
    if(window.Plotly){ onOk(); return; }
    if(!urls.length){ onFail(); return; }
    const url = urls[0];
    const s = document.createElement('script'); s.src=url; s.async=true; s.onload=()=>onOk(); s.onerror=()=>loadPlotly(urls.slice(1), onOk, onFail);
    document.head.appendChild(s);
  }

  // ======== Build plots after Plotly loads ========
  function buildPlots(){
    const t = TXT[LANG];
    // Time plot
    const inD = decimateXY(x), y1D = decimateXY(state.y1), y2D = decimateXY(state.y2);
    Plotly.newPlot('timePlot', [
      {type:'scatter', mode:'lines', name:t.traceIn, x:inD.x, y:inD.y, line:{width:1.5, color:COLORS.input}},
      {type:'scatter', mode:'lines', name:t.traceY1, x:y1D.x, y:y1D.y, line:{width:2.5, color:COLORS.f1}},
      {type:'scatter', mode:'lines', name:t.traceY2, x:y2D.x, y:y2D.y, line:{width:2.5, color:COLORS.f2}}
    ], {
      margin:{l:60,r:16,t:100,b:50},
      xaxis:{title:'t (s)'},
      yaxis:{title:'Amplitude',range:[-1,1]},
      legend:{orientation:'h', x:0.5, xanchor:'center', y:1.02, yanchor:'bottom'},
      title:{text:'<b>'+t.timeTitle+'</b>', x:0.5, xanchor:'center', font:{size:20}},
      uirevision:'keep',
      paper_bgcolor: cssVar('--paper'), plot_bgcolor: cssVar('--plot')
    }, {responsive:true, displaylogo:false}).then(()=>{ timeBuilt=true; });

    // Bode
    bodeCache1 = bodeFor(state.fc1); bodeCache2 = bodeFor(state.fc2);
    const y1 = state.bodeDb ? bodeCache1.mag.map(m=>20*Math.log10(m)) : bodeCache1.mag;
    const y2 = state.bodeDb ? bodeCache2.mag.map(m=>20*Math.log10(m)) : bodeCache2.mag;
    Plotly.newPlot('bodePlot', [
      {type:'scatter', mode:'lines', name:t.fc1, x:bodeCache1.f, y:y1, line:{color:COLORS.f1}},
      {type:'scatter', mode:'lines', name:t.fc2, x:bodeCache2.f, y:y2, line:{color:COLORS.f2}}

    ], {
      margin:{l:70,r:16,t:100,b:50},
      xaxis:{title:t.bodeX, type:'log'},
      yaxis:{title: state.bodeDb ? t.bodeYdB : t.bodeYlin},
      legend:{orientation:'h', x:0.5, xanchor:'center', y:1.02, yanchor:'bottom'},
      title:{text:'<b>'+t.bodeTitle+'</b>', x:0.5, xanchor:'center', font:{size:20}},
      uirevision:'keep',
      paper_bgcolor: cssVar('--paper'), plot_bgcolor: cssVar('--plot')
    }, {responsive:true, displaylogo:false}).then(()=>{ bodeBuilt=true; $('#status').textContent = ''; });
  }

  function applyBodeMode(){
    if(!(window.Plotly && bodeCache1 && bodeCache2 && bodeBuilt)) return;
    const t = TXT[LANG];
    const y1 = state.bodeDb ? bodeCache1.mag.map(m=>20*Math.log10(m)) : bodeCache1.mag;
    const y2 = state.bodeDb ? bodeCache2.mag.map(m=>20*Math.log10(m)) : bodeCache2.mag;
    Plotly.update('bodePlot', {y:[y1,y2], name:[t.fc1, t.fc2]}, {}, [0,1]);
    Plotly.relayout('bodePlot', {yaxis:{title: state.bodeDb ? t.bodeYdB : t.bodeYlin}});
  }

  function refreshAll(){
    updateFilters();
    if(window.Plotly && timeBuilt){
      const inD = decimateXY(x), y1D = decimateXY(state.y1), y2D = decimateXY(state.y2);
      Plotly.update('timePlot', {x:[inD.x,y1D.x,y2D.x], y:[inD.y,y1D.y,y2D.y]}, {}, [0,1,2]);
    }
    bodeCache1 = bodeFor(state.fc1); bodeCache2 = bodeFor(state.fc2);
    applyBodeMode();
  }

  // ======== Sliders & checkbox ========
  const fc1 = $('#fc1'), fc2 = $('#fc2'); const fc1Val=$('#fc1Val'), fc2Val=$('#fc2Val');
  fc1.value = hzToSliderVal(INIT_FC1).toFixed(4);
  fc2.value = hzToSliderVal(INIT_FC2).toFixed(4);
  fc1Val.textContent = INIT_FC1.toLocaleString() + ' Hz';
  fc2Val.textContent = INIT_FC2.toLocaleString() + ' Hz';
  function setFc1(){ state.fc1 = clampFc(sliderValToHz(fc1.value)); fc1Val.textContent = state.fc1.toLocaleString()+' Hz'; refreshAll(); buildAudioBuffers(); }
  function setFc2(){ state.fc2 = clampFc(sliderValToHz(fc2.value)); fc2Val.textContent = state.fc2.toLocaleString()+' Hz'; refreshAll(); buildAudioBuffers(); }
  fc1.addEventListener('input', setFc1); fc2.addEventListener('input', setFc2);
  const bodeDb = $('#bodeDb'); bodeDb.addEventListener('change', ()=>{ state.bodeDb = bodeDb.checked; applyBodeMode(); });

  // ======== Audio ========
  let actx=null, currentSources=[];
  function ensureCtx(){ if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)({sampleRate:fs}); }
  function bufferFromArray(arr){ ensureCtx(); const b=actx.createBuffer(1, arr.length, fs); b.copyToChannel(arr,0,0); return b; }
  function buildAudioBuffers(){ state.buffers.in=bufferFromArray(x); state.buffers.y1=bufferFromArray(state.y1); state.buffers.y2=bufferFromArray(state.y2); }
  function stopAll(){ currentSources.forEach(s=>{ try{s.stop(0);}catch{} }); currentSources=[]; }
  function play(buf){ ensureCtx(); stopAll(); const s=actx.createBufferSource(); s.buffer=buf; s.connect(actx.destination); s.start(); currentSources.push(s); }
  $('#playIn').addEventListener('click', ()=> play(state.buffers.in));
  $('#playY1').addEventListener('click', ()=> play(state.buffers.y1));
  $('#playY2').addEventListener('click', ()=> play(state.buffers.y2));
  $('#stopAll').addEventListener('click', stopAll);

  // ======== Init (order matters) ========
  $('#year').textContent = new Date().getFullYear();
  setLang('en');
  updateFilters();
  buildAudioBuffers();
  // Colores de botones = colores de las curvas
  paintButton('#playIn', COLORS.input); // gris
  paintButton('#playY1', COLORS.f1);    // azul
  paintButton('#playY2', COLORS.f2);    // naranja


  // Load Plotly â†’ build charts
  loadPlotly(PLOTLY_URLS,
    ()=>{ $('#status').textContent = 'Building chartsâ€¦'; buildPlots(); },
    ()=>{ $('#status').textContent = 'Could not load Plotly (offline or blocked). Audio and controls still work.'; }
  );

  // Resize after plots exist
  window.addEventListener('resize', ()=> {
    if(window.Plotly && timeBuilt && bodeBuilt){
      const h = window.innerHeight - 20;
      Plotly.relayout('timePlot', {height:h, paper_bgcolor:cssVar('--paper'), plot_bgcolor:cssVar('--plot')});
      Plotly.relayout('bodePlot', {height:h, paper_bgcolor:cssVar('--paper'), plot_bgcolor:cssVar('--plot')});
    }
  });
})();
</script>
</body>
</html>
